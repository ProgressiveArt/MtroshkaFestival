@using Microsoft.ApplicationInsights.AspNetCore.Extensions
@using EnumsNET
@using MetroshkaFestival.Application.Commands.Records
@using MetroshkaFestival.Application.WebModels.Tournaments.Teams
@using MetroshkaFestival.Core.Models.Common
@using MetroshkaFestival.Data.Entities
@using Microsoft.AspNetCore.Identity
@model MetroshkaFestival.Application.Queries.Models.Matches.MatchListModel
@inject SignInManager<User> _signInManager
@{
    ViewData["Title"] = "Фестиваль \"МЕТРОШКА\" - Матчи";
    ViewData["Controller"] = "Match";
    var isAuthenticated = _signInManager?.Context?.User?.Identity?.IsAuthenticated ?? false;
    var returnUrl = Context.Request.GetUri().AbsoluteUri;
    var stageNumbers = Model.Matches.Select(x => x.StageNumber).Distinct().ToArray();
}
<div class="row">
    <h3 class="mt-3 col-sm-10">Турнир: @(Model.Query.TournamentNameAndCategory)</h3>
    <div class="mt-3 mb-2 col-sm-2 d-flex justify-content-center" style="transform: rotate(0);">
        <a href="@Model.Query.ReturnUrl" class="btn btn-outline-dark stretched-link ">Вернуться в профиль турнира</a>
    </div>
    <h3 class="mt-3 col-sm">Матчи | Всего: @Model.Matches.Count</h3>
    @if ((isAuthenticated && !Model.TournamentIsOver || isAuthenticated) && stageNumbers.LastOrDefault() != StageNumber.Final)
    {
        <a asp-controller="Match" asp-action="Index" class="link-dark" aria-hidden="True"
           asp-all-route-data="@(new Dictionary<string, string> {{"returnUrl", Model.Query.ReturnUrl}, {"tournamentId", Model.Query.TournamentId.ToString()}, {"ageGroupName", Model.Query.AgeGroupName}, {"tournamentNameAndCategory", Model.Query.TournamentNameAndCategory}, {"IsAddMatches", true.ToString()}})">
            Сгенерировать матчи
        </a>
    }
    @if (Model.Error != null)
    {
        <div id="my-alert" class="alert alert-danger alert-dismissible fade show" role="alert">
            <div class="">
                <div class="text-danger m-0 w-50">@Model.Error</div>
            </div>
        </div>
    }
    <div class="dropdown-divider"></div>
</div>

@if (stageNumbers.Any())
{
@foreach (var stageNumber in stageNumbers)
{
    <p>
        <button class="btn btn-secondary col-sm-12 disabled link-info" type="button" data-bs-toggle="collapse@((int) stageNumber)" data-bs-target="#collapse@((int) stageNumber)" aria-expanded="false" aria-controls="collapse@((int) stageNumber)">
            @stageNumber.AsString(EnumFormat.Description)
        </button>
    </p>
    <div class="collapse@((int) stageNumber)" id="collapse@((int) stageNumber)">
        <div class="card card-body">
            <div class="text-center d-flex justify-content-center">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        @if (isAuthenticated)
                        {
                            <th scope="col" class="table-dark w-auto">ID</th>
                        }
                        <th scope="col" class="table-dark w-auto">Соперники</th>
                        <th scope="col" class="table-dark w-auto">Номер поля</th>
                        <th scope="col" class="table-dark w-auto">Время проведения</th>
                        <th scope="col" class="table-dark w-auto">Счёт матча</th>
                        <th scope="col" class="table-dark w-auto">Счёт по пенальти</th>
                        <th scope="col" class="table-dark w-auto">Победитель</th>
                        @if (isAuthenticated)
                        {
                            <th scope="col" class="table-dark w-auto">Действие</th>
                        }
                    </tr>
                    </thead>
                    @if (Model.Matches.Any())
                    {
                        <tbody>
                        @foreach (var match in Model.Matches.Where(x => x.StageNumber == stageNumber))
                        {
                            <tr>
                                @if (isAuthenticated)
                                {
                                    <td class="p-1 text-center">@match.MatchId</td>
                                }
                                <td class="p-1 text-center">
                                    <a asp-controller="Team" asp-action="GetTeamSummaryPage" class="link-dark" aria-hidden="True"
                                       asp-all-route-data="@(new Dictionary<string, string> {{"returnUrl", returnUrl}, {"tournamentId", Model.Query.TournamentId.ToString()}, {"ageGroupName", Model.Query.AgeGroupName}, {"teamId", match.FirstTeamId.ToString()}, {"tournamentNameAndCategory", Model?.Query.TournamentNameAndCategory}})">
                                        @match.FirstTeamName
                                    </a>
                                    -
                                    <a asp-controller="Team" asp-action="GetTeamSummaryPage" class="link-dark" aria-hidden="True"
                                       asp-all-route-data="@(new Dictionary<string, string> {{"returnUrl", returnUrl}, {"tournamentId", Model.Query.TournamentId.ToString()}, {"ageGroupName", Model.Query.AgeGroupName}, {"teamId", match.SecondTeamId.ToString()}, {"tournamentNameAndCategory", Model?.Query.TournamentNameAndCategory}})">
                                        @match.SecondTeamName
                                    </a>
                                </td>
                                <td class="p-1 text-center">@match.FieldNumber.AsString(EnumFormat.Description)</td>
                                <td class="p-1 text-center">@match.MatchDateTime</td>
                                <td class="p-1 text-center">@match.FirstTeamGoalsScore : @match.SecondTeamGoalsScore</td>
                                <td class="p-1 text-center">@match.FirstTeamPenaltyGoalsScore : @match.SecondTeamPenaltyGoalsScore</td>
                                <td class="p-1 text-center">@match.MatchFinalResult.AsString(EnumFormat.Description)</td>
                                @if (isAuthenticated)
                                {
                                    <td class="p-1 text-center">
                                            <a asp-controller="Match" asp-action="GetUpdateMatchPage" asp-route-matchId="@match.MatchId" asp-route-returnUrl="@returnUrl" class="btn btn-success btn-md btn-block" >Изменить</a>
                                    </td>
                                }
                            </tr>
                        }
                        </tbody>
                    }
                </table>
            </div>
        </div>
    </div>
}
}

@section Scripts{
    <script>
        $(function(){
            window.setTimeout(function(){
                $('#my-alert').alert('close');
            },5000);
        });
    </script>
}